<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis v4.0 - Phoenix Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root { --bg-dark: #111827; --bg-medium: #1f2937; --accent: #4f46e5; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-dark); color: #e5e7eb; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-bubble { animation: fadeIn 0.3s ease-out forwards; }

        @keyframes typing { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .prose pre { position: relative; }
        .copy-btn { position: absolute; top: 0.5rem; left: 0.5rem; background: #374151; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .prose pre:hover .copy-btn { opacity: 1; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-80 bg-black/20 flex flex-col p-4 transition-transform duration-300 -translate-x-full md:translate-x-0 md:relative fixed h-full z-20">
        <h1 class="text-2xl font-bold text-white mb-4">مکالمات</h1>
        <div id="conversation-list" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
    </aside>

    <main class="flex-1 flex flex-col h-full bg-bg-dark">
        <header class="flex-shrink-0 p-4 flex justify-between items-center border-b border-white/10">
            <div class="flex items-center gap-3">
                <button id="menu-btn" class="md:hidden p-2 rounded-lg hover:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <h2 id="chat-title" class="text-xl font-bold text-white">Jarvis Phoenix</h2>
            </div>
            <select id="model-select" class="bg-bg-medium border border-white/20 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--accent)]">
                {% for key, model in models.items() %}
                    <option value="{{ key }}" class="bg-gray-900">{{ model.name }}</option>
                {% endfor %}
            </select>
        </header>

        <div id="chat-history" class="flex-1 p-4 overflow-y-auto space-y-6"></div>

        <div id="error-banner" class="hidden bg-red-500/80 text-white text-center p-2">
            <span id="error-message"></span>
            <button id="error-close-btn" class="float-left font-bold">&times;</button>
        </div>

        <footer class="p-4">
            <div class="relative">
                <form id="chat-form" class="flex items-center gap-3">
                    <textarea id="chat-input" placeholder="پیام شما..." rows="1" class="w-full bg-bg-medium rounded-lg p-4 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"></textarea>
                    <button type="submit" id="send-button" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-[var(--accent)] rounded-full text-white hover:bg-indigo-500 transition disabled:bg-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </form>
                <button id="stop-button" class="hidden absolute inset-0 w-full h-full bg-red-500/90 rounded-lg text-white font-bold">توقف تولید پاسخ</button>
            </div>
        </footer>
    </main>

    <script>
    const App = {
        // --- Elements ---
        els: {
            chatHistory: document.getElementById('chat-history'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            sendButton: document.getElementById('send-button'),
            stopButton: document.getElementById('stop-button'),
            errorBanner: document.getElementById('error-banner'),
            errorMessage: document.getElementById('error-message'),
            errorCloseBtn: document.getElementById('error-close-btn'),
            sidebar: document.getElementById('sidebar'),
            menuBtn: document.getElementById('menu-btn'),
            modelSelect: document.getElementById('model-select'),
        },

        // --- State ---
        state: {
            ws: null,
            currentConversationId: null,
            isAwaitingResponse: false,
            reconnectAttempts: 0,
        },
        
        // --- Initialization ---
        init() {
            this.connectWebSocket();
            this.setupEventListeners();
            // Load conversations, etc.
        },
        
        // --- WebSocket Logic ---
        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.state.ws = new WebSocket(`${protocol}//${window.location.host}/api/ws/chat`);
            
            this.state.ws.onopen = () => {
                console.log("WebSocket Connected");
                this.hideError();
                this.state.reconnectAttempts = 0;
            };
            
            this.state.ws.onmessage = this.handleMessage.bind(this);
            
            this.state.ws.onclose = () => {
                console.warn("WebSocket Disconnected");
                this.setAwaitingResponse(false);
                if (this.state.reconnectAttempts < 5) {
                    this.state.reconnectAttempts++;
                    this.showError(`اتصال قطع شد. تلاش برای اتصال مجدد... (${this.state.reconnectAttempts})`);
                    setTimeout(() => this.connectWebSocket(), 3000);
                } else {
                    this.showError("امکان اتصال به سرور وجود ندارد. لطفاً صفحه را رفرش کنید.");
                }
            };
            
            this.state.ws.onerror = (err) => {
                console.error("WebSocket Error:", err);
                this.showError("خطا در اتصال WebSocket.");
            };
        },
        
        handleMessage(event) {
            const data = JSON.parse(event.data);
            
            if (data.error) {
                this.appendMessage('error', data.error);
                this.setAwaitingResponse(false);
                return;
            }
            
            let streamingBubble = document.querySelector('.streaming');
            if (!streamingBubble) {
                streamingBubble = this.appendMessage('model', '', true);
            }
            
            try {
                const textChunk = data.candidates[0].content.parts[0].text;
                const contentEl = streamingBubble.querySelector('.prose');
                contentEl.innerText += textChunk; // Use innerText to avoid HTML injection
                this.scrollToBottom();
            } catch (e) {
                // This might be the end of stream or an empty chunk
                if (streamingBubble) {
                    this.finalizeMessage(streamingBubble);
                }
            }
        },

        // --- UI & Interaction ---
        appendMessage(role, content, isStreaming = false) {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble flex items-start gap-3';
            
            let html = '';
            if (role === 'user') {
                html = `<div class="w-8 h-8 rounded-full bg-indigo-600 flex-shrink-0"></div><div class="prose prose-invert max-w-none bg-bg-medium p-3 rounded-lg">${marked.parse(content)}</div>`;
            } else if (role === 'model') {
                bubble.classList.add(isStreaming ? 'streaming' : '');
                const typingIndicator = `<div class="flex gap-1.5 items-center"><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div></div>`;
                html = `<div class="w-8 h-8 rounded-full bg-teal-600 flex-shrink-0"></div><div class="prose prose-invert max-w-none">${isStreaming ? typingIndicator : marked.parse(content)}</div>`;
            } else if (role === 'error') {
                 html = `<div class="w-full text-center p-2 bg-red-500/20 text-red-300 rounded-lg">${content}</div>`;
            }
            
            bubble.innerHTML = html;
            this.els.chatHistory.appendChild(bubble);
            this.scrollToBottom();
            return bubble;
        },
        
        finalizeMessage(bubble) {
            bubble.classList.remove('streaming');
            const contentEl = bubble.querySelector('.prose');
            // Re-parse the full content with Markdown and highlight
            contentEl.innerHTML = marked.parse(contentEl.innerText);
            contentEl.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                this.addCopyButton(block.parentElement);
            });
            this.setAwaitingResponse(false);
        },
        
        addCopyButton(preElement) {
            const button = document.createElement('button');
            button.className = 'copy-btn';
            button.innerText = 'کپی';
            button.onclick = () => {
                navigator.clipboard.writeText(preElement.querySelector('code').innerText);
                button.innerText = 'کپی شد!';
                setTimeout(() => button.innerText = 'کپی', 2000);
            };
            preElement.appendChild(button);
        },

        setAwaitingResponse(isWaiting) {
            this.state.isAwaitingResponse = isWaiting;
            this.els.sendButton.disabled = isWaiting;
            this.els.stopButton.classList.toggle('hidden', !isWaiting);
        },

        handleSend(event) {
            event.preventDefault();
            const messageText = this.els.chatInput.value.trim();
            if (!messageText || !this.state.ws || this.state.ws.readyState !== WebSocket.OPEN) return;
            
            this.appendMessage('user', messageText);
            
            const payload = {
                type: "chat",
                conversation_id: this.state.currentConversationId || "new", // Handle new conv
                model: this.els.modelSelect.value,
                message: { role: "user", parts: [{ text: messageText }] }
            };
            this.state.ws.send(JSON.stringify(payload));
            
            this.els.chatInput.value = '';
            this.setAwaitingResponse(true);
        },

        handleStop() {
            if (!this.state.isAwaitingResponse) return;
            this.state.ws.send(JSON.stringify({ type: "stop" }));
            // Find the last streaming bubble and finalize it immediately for better UX
            const streamingBubble = document.querySelector('.streaming');
            if (streamingBubble) this.finalizeMessage(streamingBubble);
        },

        showError(message) {
            this.els.errorMessage.textContent = message;
            this.els.errorBanner.classList.remove('hidden');
        },
        
        hideError() {
            this.els.errorBanner.classList.add('hidden');
        },

        scrollToBottom() {
            this.els.chatHistory.scrollTop = this.els.chatHistory.scrollHeight;
        },

        setupEventListeners() {
            this.els.chatForm.addEventListener('submit', this.handleSend.bind(this));
            this.els.stopButton.addEventListener('click', this.handleStop.bind(this));
            this.els.errorCloseBtn.addEventListener('click', this.hideError.bind(this));
            this.els.menuBtn.addEventListener('click', () => {
                this.els.sidebar.classList.toggle('-translate-x-full');
            });
        },
    };

    App.init();
    </script>
</body>
</html>
