<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Elite - Intelligent Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --font-family: 'Vazirmatn', sans-serif; --bg-primary: #0D1117; --bg-secondary: #161B22; --border-color: #30363D; --text-primary: #C9D1D9; --text-secondary: #8B949E; --accent: #58A6FF; --code-bg: #010409; --danger: #F85149; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); }
        .prose { color: var(--text-primary); max-width: 100% !important; } .prose pre { background-color: var(--code-bg) !important; padding: 1rem; border-radius: 8px; position: relative; direction: ltr; text-align: left; white-space: pre-wrap; word-wrap: break-word; }
        .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #21262D; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 0.25rem 0.5rem; border-radius: 5px; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        pre:hover .copy-btn { opacity: 1; }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; max-width: 400px; }
        .toast { padding: 1rem 1.5rem; color: white; border-radius: 8px; margin-bottom: 0.75rem; background-color: var(--danger); font-size: 0.9rem; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-72 bg-bg-secondary border-l border-border-color flex-shrink-0 flex flex-col">
        <div class="p-4 border-b border-border-color flex items-center justify-between"><h1 class="text-lg font-bold">Jarvis Elite</h1><button id="new-chat-btn" title="چت جدید" class="p-2 rounded-lg hover:bg-[#21262D] text-xl font-bold">+</button></div>
        <nav id="conversation-list" class="flex-1 overflow-y-auto py-2 px-2"></nav>
    </aside>

    <main class="flex-1 flex flex-col bg-bg-primary">
        <header class="p-3 border-b border-border-color flex items-center justify-between"><h2 id="chat-title" class="font-bold text-base">مکالمه جدید</h2><select id="model-select" class="bg-bg-secondary border border-border-color rounded-md px-3 py-1.5 text-xs"></select></header>
        <div id="chat-history" class="flex-1 p-6 overflow-y-auto"></div>
        <footer class="p-4"><form id="chat-form" class="relative max-w-4xl mx-auto"><textarea id="chat-input" placeholder="پیام شما..." rows="1" class="w-full bg-bg-secondary border border-border-color rounded-lg py-3 pr-4 pl-24 resize-none"></textarea><div class="absolute left-3 top-1/2 -translate-y-1/2 flex gap-2"><button type="button" id="stop-button" title="توقف" class="hidden w-8 h-8 items-center justify-center rounded-md bg-red-600 text-white font-bold text-lg">■</button><button type="submit" id="send-button" title="ارسال" class="w-8 h-8 rounded-md bg-accent text-white flex items-center justify-center text-lg">▲</button></div></form></footer>
    </main>
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const el = {
                convList: document.getElementById('conversation-list'), chatTitle: document.getElementById('chat-title'),
                modelSelect: document.getElementById('model-select'), chatHistory: document.getElementById('chat-history'),
                chatForm: document.getElementById('chat-form'), chatInput: document.getElementById('chat-input'),
                sendBtn: document.getElementById('send-button'), stopBtn: document.getElementById('stop-button'),
                newChatBtn: document.getElementById('new-chat-btn'), toastContainer: document.getElementById('toast-container'),
            };

            let ws, currentConversationId, isGenerating = false, lastBubble, streamBuffer;

            marked.setOptions({ gfm: true, breaks: true, highlight: (code, lang) => hljs.highlightAuto(code, lang ? [lang] : undefined).value });
            
            const showToast = (msg) => { const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = msg; el.toastContainer.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 8000); };
            const addCopyButtons = () => { el.chatHistory.querySelectorAll('pre:not(:has(.copy-btn))').forEach(pre => { const btn = document.createElement('button'); btn.innerText = 'کپی'; btn.className = 'copy-btn'; btn.onclick = () => { navigator.clipboard.writeText(pre.querySelector('code').innerText); btn.innerText = 'کپی شد!'; setTimeout(() => btn.innerText = 'کپی', 2000); }; pre.appendChild(btn); }); };
            
            const createBubble = (role, content = '') => { const b = document.createElement('div'); b.className = `prose prose-invert max-w-none p-4 rounded-lg mb-4 ${role === 'user' ? 'bg-accent text-white' : 'bg-bg-secondary'}`; if(content) b.innerHTML = marked.parse(content); el.chatHistory.appendChild(b); el.chatHistory.scrollTop = el.chatHistory.scrollHeight; return b; };

            const loadConversations = async () => { const convs = await(await fetch('/api/conversations')).json(); el.convList.innerHTML = ''; convs.forEach(c => { const i = document.createElement('div'); i.className = 'p-2 hover:bg-[#21262D] cursor-pointer rounded text-ellipsis overflow-hidden whitespace-nowrap'; i.dataset.id = c.id; i.textContent = c.title; i.onclick = () => loadConversation(c.id); el.convList.appendChild(i); }); if(convs.length > 0 && !currentConversationId) loadConversation(convs[0].id);};
            const loadConversation = async (id) => { if(isGenerating) return; currentConversationId = id; const data = await(await fetch(`/api/conversations/${id}/messages`)).json(); el.chatHistory.innerHTML = ''; data.messages.forEach(m => createBubble(m.role, m.parts[0].text)); addCopyButtons(); el.chatTitle.textContent = document.querySelector(`[data-id="${id}"]`)?.textContent;};

            const connect = () => {
                ws = new WebSocket(`${location.protocol.replace('http', 'ws')}//${location.host}/api/ws/chat`);
                ws.onmessage = ({data}) => {
                    try { const msg = JSON.parse(data); handleWsMessage(msg); } 
                    catch(e) { if (isGenerating) { streamBuffer += data; lastBubble.innerHTML = marked.parse(streamBuffer); el.chatHistory.scrollTop = el.chatHistory.scrollHeight; }}
                };
                ws.onclose = () => setTimeout(connect, 3000);
            };
            
            const handleWsMessage = (msg) => {
                switch(msg.type) {
                    case 'info': if(!currentConversationId) { currentConversationId = msg.conversation_id; loadConversations(); } break;
                    case 'title_update': { const i = document.querySelector(`[data-id="${msg.conversation_id}"]`); if(i) i.textContent = msg.title; if(currentConversationId === msg.conversation_id) el.chatTitle.textContent = msg.title; break; }
                    case 'stream_end': stopGeneration(false); break;
                    case 'error': { showToast(msg.content); stopGeneration(false); break; }
                }
            };
            
            const stopGeneration = (sendSignal) => { if(!isGenerating) return; isGenerating = false; if(sendSignal && ws?.readyState === 1) ws.send(JSON.stringify({ type: "stop" })); addCopyButtons(); el.sendBtn.classList.remove('hidden'); el.stopBtn.classList.add('hidden');};
            const sendMessage = (msg) => {
                if(!msg.trim() || isGenerating || ws?.readyState !== 1) return;
                createBubble('user', msg); el.chatInput.value = ''; isGenerating = true; el.sendBtn.classList.add('hidden'); el.stopBtn.classList.remove('hidden'); lastBubble = createBubble('model'); streamBuffer = '';
                ws.send(JSON.stringify({ type: 'chat', message: msg, conversation_id: currentConversationId, model: el.modelSelect.value }));
            };
            
            const populateModels = async () => {
                const { models } = await (await fetch('/api/models')).json();
                el.modelSelect.innerHTML = '';
                for (const key in models) { const opt = document.createElement('option'); opt.value = key; opt.textContent = models[key].name; opt.title = models[key].description;
                    // ** Best default model with highest quota **
                    if (key === 'gemma-2-9b-it') opt.selected = true;
                    el.modelSelect.appendChild(opt); 
                }
            };
            
            el.chatForm.addEventListener('submit', (e) => { e.preventDefault(); sendMessage(el.chatInput.value); });
            el.chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(el.chatInput.value); }});
            el.stopBtn.addEventListener('click', () => stopGeneration(true));
            el.newChatBtn.addEventListener('click', () => { currentConversationId = null; el.chatHistory.innerHTML = ''; el.chatTitle.textContent = 'مکالمه جدید'; });

            populateModels();
            loadConversations();
            connect();
        });
    </script>
</body>
</html>
