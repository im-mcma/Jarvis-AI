<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis v8.1 - Prestige Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Vazirmatn', sans-serif;
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --bg-tertiary: #21262D;
            --border-color: #30363D;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --accent: #58A6FF;
            --accent-hover: #79C0FF;
            --code-bg: #010409;
        }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .prose { color: var(--text-primary); max-width: 100% !important; }
        .prose pre { background-color: var(--code-bg) !important; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9em; position: relative; }
        .prose code { font-family: 'Cascadia Code', 'JetBrains Mono', monospace; }
        .prose p, .prose li, .prose h1, .prose h2, .prose h3 { user-select: text !important; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        .sidebar-item { transition: background-color 0.2s ease, border-color 0.2s ease; border-right: 3px solid transparent; }
        .sidebar-item:hover { background-color: var(--bg-tertiary); }
        .sidebar-item.active { background-color: var(--bg-tertiary); border-color: var(--accent); }
        
        #chat-input { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; padding-left: 3rem; padding-right: 1rem; }
        #chat-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); }

        .btn { transition: all 0.2s ease; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); transform: translateY(-1px); }
        .btn-primary:disabled { background-color: #30363D; cursor: not-allowed; opacity: 0.7; }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem; /* In RTL, left is correct */
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        pre:hover .copy-btn { opacity: 1; }
        .copy-btn:hover { background-color: var(--border-color); color: var(--text-primary); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside id="sidebar" class="w-72 bg-bg-secondary border-l border-border-color flex-shrink-0 flex flex-col transition-all duration-300 md:relative md:translate-x-0 -translate-x-full fixed h-full z-20">
        <div class="p-4 border-b border-border-color flex items-center justify-between">
            <h1 class="text-lg font-bold">Jarvis Prestige Pro</h1>
            <button id="new-chat-btn" title="چت جدید" class="p-2 rounded-lg hover:bg-bg-tertiary btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
        <nav id="conversation-list" class="flex-1 overflow-y-auto py-2"></nav>
    </aside>

    <main class="flex-1 flex flex-col bg-bg-primary">
        <header class="flex-shrink-0 p-3 border-b border-border-color flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <button id="menu-btn" class="md:hidden p-2 rounded-lg hover:bg-bg-tertiary btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <h2 id="chat-title" class="font-bold text-base text-text-primary truncate">مکالمه جدید</h2>
            </div>
            <select id="model-select" class="bg-bg-secondary border border-border-color rounded-md px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-accent"></select>
        </header>
        
        <div id="chat-history" class="flex-1 p-6 overflow-y-auto">
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center animate-fade-in">
                
                <h2 class="text-2xl font-bold mt-4">Jarvis Prestige Pro</h2>
                <p class="text-text-secondary mt-2">چگونه می‌توانم امروز به شما کمک کنم؟</p>
                 <div class="grid grid-cols-2 gap-3 mt-8 w-full max-w-md">
                    <div class="bg-bg-secondary p-3 rounded-lg text-right cursor-pointer hover:bg-bg-tertiary transition-colors" onclick="setExamplePrompt('یک برنامه پایتون برای پیش‌بینی آب و هوا بنویس.')">
                        <p class="font-bold text-sm">نوشتن کد پایتون</p>
                        <p class="text-xs text-text-secondary">برای پیش‌بینی آب و هوا</p>
                    </div>
                    <div class="bg-bg-secondary p-3 rounded-lg text-right cursor-pointer hover:bg-bg-tertiary transition-colors" onclick="setExamplePrompt('چند ایده برای یک استارت‌آپ در حوزه هوش مصنوعی بده.')">
                        <p class="font-bold text-sm">ایده برای استارت‌آپ</p>
                        <p class="text-xs text-text-secondary">در حوزه هوش مصنوعی</p>
                    </div>
                 </div>
            </div>
        </div>
        
        <footer class="p-4 flex-shrink-0">
            <div class="relative max-w-4xl mx-auto">
                <form id="chat-form">
                    <textarea id="chat-input" placeholder="پیام خود را اینجا بنویسید... (Shift+Enter برای خط جدید)" rows="1" class="w-full rounded-lg py-3 resize-none overflow-y-hidden"></textarea>
                    <button type="submit" id="send-button" title="ارسال پیام" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-md btn btn-primary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                    <button type="button" id="stop-button" title="توقف" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-md btn bg-red-600 hover:bg-red-700 text-white hidden">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
                    </button>
                </form>
            </div>
        </footer>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const ELEMENTS = {
        sidebar: document.getElementById('sidebar'),
        menuBtn: document.getElementById('menu-btn'),
        newChatBtn: document.getElementById('new-chat-btn'),
        conversationList: document.getElementById('conversation-list'),
        chatTitle: document.getElementById('chat-title'),
        modelSelect: document.getElementById('model-select'),
        chatHistory: document.getElementById('chat-history'),
        welcomeScreen: document.getElementById('welcome-screen'),
        chatForm: document.getElementById('chat-form'),
        chatInput: document.getElementById('chat-input'),
        sendButton: document.getElementById('send-button'),
        stopButton: document.getElementById('stop-button')
    };

    let ws = null;
    let currentConversationId = null;
    let isGenerating = false;
    let lastMessageElement = null;

    const API_URLS = {
        models: "/api/models",
        conversations: "/api/conversations",
        messages: (id) => `/api/conversations/${id}`
    };

    // --- بهبود: ایجاد حباب پیام با استفاده از Template Literals برای خوانایی بهتر ---
    function createMessageBubble(role, content = "") {
        const isUser = role === "user";
        const bubble = document.createElement("div");
        bubble.className = "flex animate-slide-in-up mb-5";

        const avatarIcon = isUser
            ? `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>`
            : `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9.4 3.44C10.12 3.15 10.91 3 11.75 3c2.76 0 5 2.24 5 5s-2.24 5-5 5c-.84 0-1.63-.15-2.35-.44l-3.21 3.21c-.47.47-1.23.47-1.7 0l-1.41-1.41c-.47-.47-.47-1.23 0-1.7l3.21-3.21zM11.75 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"></path></svg>`;

        bubble.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center ${isUser ? 'bg-accent text-white' : 'bg-bg-tertiary'}">
                ${avatarIcon}
            </div>
            <div class="mr-4 w-full overflow-hidden">
                <p class="font-bold text-sm mb-1">${isUser ? 'شما' : 'Jarvis'}</p>
                <div class="message-content prose prose-invert bg-bg-secondary p-4 rounded-lg rounded-tr-none">
                    ${content ? marked.parse(content) : ''}
                </div>
            </div>
        `;

        if (content === "") { // برای نمایش نشانگر "در حال نوشتن"
             bubble.querySelector('.message-content').innerHTML = `
                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                    <div class="w-2 h-2 bg-text-secondary rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-text-secondary rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-text-secondary rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                </div>`;
        }
        
        ELEMENTS.chatHistory.appendChild(bubble);
        scrollToBottom();
        return bubble;
    }

    function updateCodeBlocks() {
        document.querySelectorAll('pre code').forEach((block) => {
            if (block.closest('pre').querySelector('.copy-btn')) return;
            
            const pre = block.closest('pre');
            hljs.highlightElement(block);
            
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-btn';
            copyButton.innerText = 'کپی';
            copyButton.onclick = () => {
                navigator.clipboard.writeText(block.innerText).then(() => {
                    copyButton.innerText = 'کپی شد!';
                    setTimeout(() => { copyButton.innerText = 'کپی'; }, 2000);
                });
            };
            pre.appendChild(copyButton);
        });
    }

    function scrollToBottom() {
        ELEMENTS.chatHistory.scrollTop = ELEMENTS.chatHistory.scrollHeight;
    }

    async function fetchConversations() {
        try {
            const response = await fetch(API_URLS.conversations);
            const data = await response.json();
            ELEMENTS.conversationList.innerHTML = '';
            data.conversations.forEach(convo => addConversationToList(convo.id, convo.title));
        } catch (error) {
            console.error("خطا در دریافت مکالمات:", error);
        }
    }
    
    function addConversationToList(id, title) {
        const item = document.createElement('a');
        item.href = "#";
        item.className = 'sidebar-item flex items-center py-2.5 px-4 truncate';
        item.dataset.id = id;
        item.textContent = title;
        item.addEventListener('click', (e) => {
            e.preventDefault();
            loadConversation(id);
            if (window.innerWidth < 768) {
                ELEMENTS.sidebar.classList.add('-translate-x-full');
            }
        });
        ELEMENTS.conversationList.prepend(item);
        return item;
    }

    async function loadConversation(id) {
        currentConversationId = id;
        ELEMENTS.welcomeScreen.classList.add('hidden');
        ELEMENTS.chatHistory.innerHTML = '';
        
        document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
        const selectedItem = document.querySelector(`.sidebar-item[data-id="${id}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
            ELEMENTS.chatTitle.textContent = selectedItem.textContent;
        }
        
        try {
            const response = await fetch(API_URLS.messages(id));
            if (!response.ok) throw new Error("مکالمه یافت نشد.");
            
            const data = await response.json();
            data.messages.forEach(msg => {
                createMessageBubble(msg.role, msg.parts[0].text);
            });
            updateCodeBlocks();
            scrollToBottom();
        } catch (error) {
            console.error("خطا در بارگذاری مکالمه:", error);
            newChat();
        }
    }

    function newChat() {
        currentConversationId = null;
        ELEMENTS.chatHistory.innerHTML = '';
        ELEMENTS.welcomeScreen.classList.remove('hidden');
        ELEMENTS.chatTitle.textContent = "مکالمه جدید";
        document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
        ELEMENTS.chatInput.value = '';
        ELEMENTS.chatInput.focus();
        adjustTextareaHeight();
    }

    function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        ws = new WebSocket(`${wsProtocol}//${window.location.host}/api/ws/chat`);
        
        ws.onopen = () => console.log("WebSocket متصل شد.");

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            } catch (e) {
                // This is likely a text chunk from the model
                if (isGenerating && lastMessageElement) {
                    const contentDiv = lastMessageElement.querySelector(".message-content");
                    if (contentDiv.querySelector('.animate-pulse')) {
                        contentDiv.innerHTML = ""; // Remove loading dots
                    }
                    contentDiv.innerHTML += marked.parse(event.data);
                    scrollToBottom();
                }
            }
        };

        ws.onclose = () => {
            console.log("WebSocket قطع شد. تلاش مجدد تا 5 ثانیه دیگر...");
            if (isGenerating) stopGeneration(false); // Stop UI generation state
            setTimeout(connectWebSocket, 5000);
        };
        
        ws.onerror = (error) => {
            console.error("خطای WebSocket:", error);
            ws.close();
        };
    }
    
    function handleWebSocketMessage(message) {
        switch (message.type) {
            case "info":
                if (!currentConversationId) {
                    currentConversationId = message.conversation_id;
                    const newTitle = "مکالمه جدید...";
                    const newItem = addConversationToList(currentConversationId, newTitle);
                    document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                    newItem.classList.add('active');
                    ELEMENTS.chatTitle.textContent = newTitle;
                }
                break;
            case "title_update":
                const item = document.querySelector(`.sidebar-item[data-id="${message.conversation_id}"]`);
                if (item) {
                    item.textContent = message.title;
                    if (currentConversationId === message.conversation_id) {
                        ELEMENTS.chatTitle.textContent = message.title;
                    }
                }
                break;
            case "stream_end":
                stopGeneration(false);
                break;
            case "error":
                 stopGeneration(false);
                 createMessageBubble("model", `**خطا:** ${message.message}`);
                 break;
        }
    }

    function startGeneration() {
        isGenerating = true;
        ELEMENTS.sendButton.disabled = true;
        ELEMENTS.sendButton.classList.add("hidden");
        ELEMENTS.stopButton.classList.remove("hidden");
        lastMessageElement = createMessageBubble("model", "");
    }
    
    function stopGeneration(sendStopSignal = true) {
        if (sendStopSignal && ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "stop" }));
        }
        isGenerating = false;
        ELEMENTS.sendButton.disabled = false;
        ELEMENTS.sendButton.classList.remove("hidden");
        ELEMENTS.stopButton.classList.add("hidden");
        updateCodeBlocks(); // Final update after stream ends
        lastMessageElement = null;
    }

    function sendMessage(message) {
        if (!message.trim() || isGenerating) return;
        
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.error("WebSocket متصل نیست.");
            createMessageBubble("model", "**خطا: اتصال برقرار نیست. لطفاً صفحه را رفرش کنید.**");
            return;
        }

        ELEMENTS.welcomeScreen.classList.add('hidden');
        createMessageBubble("user", message);
        startGeneration();
        ELEMENTS.chatInput.value = '';
        adjustTextareaHeight();

        const payload = {
            type: "chat",
            conversation_id: currentConversationId,
            model: ELEMENTS.modelSelect.value,
            message: {
                role: "user",
                parts: [{ text: message }]
            }
        };
        ws.send(JSON.stringify(payload));
    }

    async function fetchAndPopulateModels() {
        try {
            const response = await fetch(API_URLS.models);
            const data = await response.json();
            ELEMENTS.modelSelect.innerHTML = '';
            for (const key in data.models) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = data.models[key].name;
                option.title = data.models[key].description;
                ELEMENTS.modelSelect.appendChild(option);
            }
        } catch (error) {
            console.error("خطا در دریافت لیست مدل‌ها:", error);
        }
    }
    
    function adjustTextareaHeight() {
        ELEMENTS.chatInput.style.height = 'auto';
        ELEMENTS.chatInput.style.height = (ELEMENTS.chatInput.scrollHeight) + 'px';
    }

    function setExamplePrompt(prompt) {
        ELEMENTS.chatInput.value = prompt;
        adjustTextareaHeight();
        ELEMENTS.chatInput.focus();
    }
    window.setExamplePrompt = setExamplePrompt; // Make it accessible from HTML onclick

    function setupEventListeners() {
        ELEMENTS.chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(ELEMENTS.chatInput.value);
        });
        
        ELEMENTS.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(ELEMENTS.chatInput.value);
            }
        });

        ELEMENTS.chatInput.addEventListener('input', adjustTextareaHeight);

        ELEMENTS.stopButton.addEventListener('click', () => stopGeneration(true));
        ELEMENTS.newChatBtn.addEventListener('click', newChat);

        ELEMENTS.menuBtn.addEventListener('click', () => {
            ELEMENTS.sidebar.classList.toggle('-translate-x-full');
        });
    }

    function init() {
        setupEventListeners();
        fetchAndPopulateModels();
        fetchConversations();
        connectWebSocket();
        adjustTextareaHeight();
    }
    
    init();
});
</script>

</body>
</html>
#ارتقای بعدی <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis v8.2 - Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Vazirmatn', sans-serif;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D;
            --border-color: #30363D; --text-primary: #C9D1D9; --text-secondary: #8B949E;
            --accent: #58A6FF; --accent-hover: #79C0FF; --code-bg: #010409; --danger: #F85149;
        }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #555; }
        .prose { color: var(--text-primary); max-width: 100% !important; }
        .prose pre { background-color: var(--code-bg) !important; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9em; position: relative; }
        .prose code { font-family: 'Cascadia Code', 'JetBrains Mono', monospace; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        #chat-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2); }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); transform: translateY(-1px); }
        pre:hover .copy-btn { opacity: 1; }
        /* ارتقا: استایل دکمه حذف و آیتم سایدبار */
        .sidebar-item { display: flex; align-items: center; justify-content: space-between; transition: background-color 0.2s ease; border-right: 3px solid transparent; }
        .sidebar-item:hover { background-color: var(--bg-tertiary); }
        .sidebar-item.active { background-color: var(--bg-tertiary); border-color: var(--accent); }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .sidebar-item:hover .delete-btn { opacity: 1; }
        /* ارتقا: استایل سیستم اعلان (Toast) */
        #toast-container { position: fixed; bottom: 1.5rem; left: 1.5rem; z-index: 100; }
        .toast { padding: 1rem 1.5rem; background-color: var(--danger); color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside id="sidebar" class="w-72 bg-bg-secondary border-l border-border-color flex-shrink-0 flex flex-col transition-all duration-300 md:relative md:translate-x-0 -translate-x-full fixed h-full z-20">
        <div class="p-4 border-b border-border-color flex items-center justify-between">
            <h1 class="text-lg font-bold">Jarvis Elite</h1>
            <button id="new-chat-btn" title="چت جدید" class="p-2 rounded-lg hover:bg-bg-tertiary transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
        </div>
        <nav id="conversation-list" class="flex-1 overflow-y-auto py-2"></nav>
    </aside>

    <main class="flex-1 flex flex-col bg-bg-primary">
        <header class="flex-shrink-0 p-3 border-b border-border-color flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <button id="menu-btn" class="md:hidden p-2 rounded-lg hover:bg-bg-tertiary">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
                <h2 id="chat-title" class="font-bold text-base text-text-primary truncate">مکالمه جدید</h2>
            </div>
            <select id="model-select" class="bg-bg-secondary border border-border-color rounded-md px-3 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-accent"></select>
        </header>
        
        <div id="chat-history" class="flex-1 p-6 overflow-y-auto">
             <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center">
                </div>
        </div>
        
        <footer class="p-4 flex-shrink-0">
            <div class="relative max-w-4xl mx-auto">
                <form id="chat-form">
                    <textarea id="chat-input" placeholder="پیام خود را اینجا بنویسید... (Shift+Enter برای خط جدید)" rows="1" class="w-full rounded-lg py-3 resize-none overflow-y-hidden bg-bg-secondary border border-border-color text-text-primary transition-all pr-4 pl-12"></textarea>
                    <button type="submit" id="send-button" title="ارسال پیام" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center rounded-md transition-all bg-accent text-white disabled:bg-bg-tertiary disabled:opacity-70">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                    <button type="button" id="stop-button" title="توقف" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 items-center justify-center rounded-md bg-red-600 hover:bg-red-700 text-white hidden">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
                    </button>
                </form>
            </div>
        </footer>
    </main>
    
    <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ... ELEMENTS and API_URLS definitions ...
    const ELEMENTS = { /* ... قبلی ... */ };
    const API_URLS = { /* ... قبلی ... */ };

    let ws = null;
    let currentConversationId = null;
    let isGenerating = false;
    let lastMessageElement = null;
    // ارتقا: بافر برای محتوای استریم شده
    let streamContentBuffer = "";

    // ارتقا: تابع نمایش اعلان (Toast)
    function showToast(message, duration = 4000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    function createMessageBubble(role, content = "") { /* ... بدون تغییر ... */ }

    // ارتقا: بهینه‌سازی پردازش استریم در فرانت‌اند
    function handleStreamChunk(chunk) {
        if (!isGenerating || !lastMessageElement) return;

        const contentDiv = lastMessageElement.querySelector(".message-content");
        if (contentDiv.querySelector('.animate-pulse')) {
            contentDiv.innerHTML = ""; // حذف انیمیشن لودینگ
        }
        
        // به بافر اضافه کرده و سپس کل محتوا را رندر می‌کنیم
        // این کار از رندر مجدد کل DOM در هر قطعه جلوگیری می‌کند و بسیار بهینه‌تر است.
        streamContentBuffer += chunk;
        contentDiv.innerHTML = marked.parse(streamContentBuffer);
        scrollToBottom();
    }
    
    // ارتقا: تابع حذف مکالمه
    async function deleteConversation(id, element) {
        if (!confirm("آیا از حذف این مکالمه مطمئن هستید؟")) return;

        try {
            const response = await fetch(`/api/conversations/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Failed to delete.');
            
            element.remove();
            if (currentConversationId === id) {
                newChat();
            }
            showToast("مکالمه با موفقیت حذف شد.", 2000);
        } catch (error) {
            console.error("Error deleting conversation:", error);
            showToast("خطا در حذف مکالمه.");
        }
    }

    function addConversationToList(id, title) {
        const item = document.createElement('div');
        item.className = 'sidebar-item group py-2.5 px-4 cursor-pointer';
        item.dataset.id = id;

        const titleSpan = document.createElement('span');
        titleSpan.className = 'truncate flex-1';
        titleSpan.textContent = title;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn p-1 rounded-md hover:bg-danger hover:text-white';
        deleteBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>`;
        
        item.appendChild(titleSpan);
        item.appendChild(deleteBtn);

        item.addEventListener('click', (e) => {
            if (e.target.closest('.delete-btn')) return;
            // ... loadConversation logic ...
        });
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteConversation(id, item);
        });
        
        ELEMENTS.conversationList.prepend(item);
        return item;
    }
    
    ws.onmessage = (event) => {
        try {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
        } catch (e) {
            handleStreamChunk(event.data);
        }
    };
    
    function stopGeneration(sendStopSignal = true) {
        // ...
        streamContentBuffer = ""; // ریست کردن بافر
        updateCodeBlocks(); 
    }

    // ... بقیه توابع جاوااسکریپت با بهبودهای جزئی ...

    function init() {
        // ...
        showToast("به جارویس خوش آمدید!", 2000);
    }
    init();
});
</script>
</body>
</html>
