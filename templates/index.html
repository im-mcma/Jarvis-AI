<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Elite - Multi-Modal Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --font-family: 'Vazirmatn', sans-serif; --bg-primary: #0D1117; --bg-secondary: #161B22; --border-color: #30363D; --text-primary: #C9D1D9; --accent: #58A6FF;}
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); }
        .mode-btn { background-color: var(--bg-secondary); border: 1px solid var(--border-color); transition: all 0.2s; }
        .mode-btn.active { border-color: var(--accent); background-color: #2a2a4c; color: white; }
        #output-container { scroll-behavior: smooth; }
        .prose { max-width: 100% !important; }
        .output-bubble { background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 100; max-width: 400px; }
        .toast { padding: 1rem; color: white; border-radius: 8px; margin-bottom: 0.75rem; background-color: #F85149; }
        .spinner { border: 4px solid rgba(255,255,255,.2); border-left-color: var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">
    <aside class="w-72 bg-bg-secondary border-l border-border-color flex-shrink-0 flex flex-col p-4 gap-4">
        <h1 class="text-xl font-bold">Jarvis Elite Gateway</h1>
        
        <div>
            <label class="text-xs text-gray-400">Û±. Ø­Ø§Ù„Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</label>
            <div id="mode-selector" class="grid grid-cols-3 gap-2 mt-2">
                <button data-mode="chat" class="mode-btn p-2 rounded-lg">ğŸ’¬ Ú†Øª</button>
                <button data-mode="image" class="mode-btn p-2 rounded-lg">ğŸ–¼ï¸ ØªØµÙˆÛŒØ±</button>
                <button data-mode="data" class="mode-btn p-2 rounded-lg">ğŸ“Š Ø¯Ø§Ø¯Ù‡</button>
            </div>
        </div>

        <div>
            <label for="model-select" class="text-xs text-gray-400">Û². Ù…Ø¯Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</label>
            <select id="model-select" class="w-full mt-2 bg-[#21262D] border border-border-color rounded-md px-3 py-1.5 text-xs"></select>
        </div>

    </aside>

    <main class="flex-1 flex flex-col bg-bg-primary">
        <div id="output-container" class="flex-1 p-6 overflow-y-auto">
             <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center">
                <h2 class="text-3xl font-bold">Ø¨Ù‡ Ú¯ÛŒØªâ€ŒÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
                <p class="text-gray-400 mt-2">ÛŒÚ© Ø­Ø§Ù„Øª Ø±Ø§ Ø§Ø² Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.</p>
            </div>
        </div>
        
        <footer class="p-4"><form id="prompt-form" class="relative max-w-4xl mx-auto"><input id="prompt-input" placeholder="Ù¾Ø±Ø§Ù…Ù¾Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." class="w-full bg-bg-secondary border border-border-color rounded-lg py-3 pr-4 pl-12"><button type="submit" id="send-button" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-md bg-accent text-white flex items-center justify-center text-lg">â–²</button></form></footer>
    </main>

    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const el = {
                modeSelector: document.getElementById('mode-selector'), modelSelect: document.getElementById('model-select'),
                outputContainer: document.getElementById('output-container'), welcomeScreen: document.getElementById('welcome-screen'),
                promptForm: document.getElementById('prompt-form'), promptInput: document.getElementById('prompt-input'),
                sendBtn: document.getElementById('send-button'), toastContainer: document.getElementById('toast-container'),
            };

            let ws, activeMode = 'chat', isGenerating = false, allModels = {};
            marked.setOptions({ gfm: true, breaks: true, highlight: (code, lang) => hljs.highlightAuto(code, lang ? [lang] : undefined).value });

            const showToast = (msg) => { const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = msg; el.toastContainer.appendChild(toast); setTimeout(() => { toast.remove(); }, 5000); };
            
            const createBubble = (content, type = 'text') => {
                const bubble = document.createElement('div');
                bubble.className = 'output-bubble animate-fade-in prose prose-invert';
                if (type === 'text') {
                    bubble.innerHTML = marked.parse(content);
                } else if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = content;
                    img.className = 'rounded-lg max-w-full h-auto';
                    bubble.appendChild(img);
                } else if (type === 'spinner') {
                     bubble.innerHTML = `<div class="flex items-center justify-center"><div class="spinner"></div></div>`;
                }
                el.outputContainer.appendChild(bubble);
                el.outputContainer.scrollTop = el.outputContainer.scrollHeight;
                return bubble;
            };

            const switchMode = (newMode) => {
                activeMode = newMode;
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`.mode-btn[data-mode="${newMode}"]`);
                if (activeBtn) activeBtn.classList.add('active');

                el.promptInput.placeholder = `Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Â«${activeBtn.innerText}Â» ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...`;
                populateModels(newMode);
                el.outputContainer.innerHTML = ''; // Clear output on mode switch
            };

            const populateModels = (mode) => {
                el.modelSelect.innerHTML = '';
                const models = allModels[mode]?.models || {};
                if (Object.keys(models).length === 0) {
                     el.modelSelect.innerHTML = `<option disabled selected>Ù…Ø¯Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø­Ø§Ù„Øª ÛŒØ§ÙØª Ù†Ø´Ø¯</option>`;
                     return;
                }
                for (const key in models) {
                    const opt = document.createElement('option');
                    opt.value = key; opt.textContent = models[key];
                    el.modelSelect.appendChild(opt);
                }
            };
            
            const connect = () => {
                ws = new WebSocket(`${location.protocol.replace('http', 'ws')}//${location.host}/api/ws/gateway`);
                ws.onmessage = ({ data }) => { handleWsMessage(JSON.parse(data)); };
                ws.onclose = () => setTimeout(connect, 3000);
            };

            let currentBubble = null;
            const handleWsMessage = (msg) => {
                el.welcomeScreen.style.display = 'none';

                switch (msg.type) {
                    case 'status':
                        if (currentBubble) currentBubble.remove();
                        currentBubble = createBubble(msg.content, 'text');
                        break;
                    case 'text_chunk':
                        if(!currentBubble || currentBubble.querySelector('.spinner')){
                            currentBubble = createBubble(msg.content, 'text');
                        } else {
                            currentBubble.innerHTML += marked.parse(msg.content);
                        }
                        break;
                    case 'image_url':
                        if (currentBubble) currentBubble.remove();
                        createBubble(msg.content, 'image');
                        break;
                    case 'stream_end':
                        isGenerating = false;
                        el.sendBtn.disabled = false;
                        if(currentBubble && currentBubble.querySelector('.spinner')) currentBubble.remove();
                        break;
                    case 'error':
                        showToast(msg.content);
                        isGenerating = false;
                        el.sendBtn.disabled = false;
                        if(currentBubble) currentBubble.remove();
                        break;
                }
                el.outputContainer.scrollTop = el.outputContainer.scrollHeight;
            };

            const sendMessage = (prompt) => {
                if (!prompt.trim() || isGenerating || ws?.readyState !== 1) return;
                isGenerating = true; el.sendBtn.disabled = true;
                currentBubble = createBubble('', 'spinner');

                ws.send(JSON.stringify({
                    type: 'generate',
                    mode: activeMode,
                    model: el.modelSelect.value,
                    prompt: prompt,
                }));
                el.promptInput.value = '';
            };

            const init = async () => {
                const res = await fetch('/api/models');
                allModels = (await res.json()).categories;
                
                el.modeSelector.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => switchMode(btn.dataset.mode));
                });
                
                el.promptForm.addEventListener('submit', e => {
                    e.preventDefault();
                    sendMessage(el.promptInput.value);
                });
                
                // Set initial state
                switchMode('chat');
                connect();
            };

            init();
        });
    </script>
</body>
</html>
